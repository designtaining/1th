<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="https://kit.fontawesome.com/9bc17173c2.js" crossorigin="anonymous"></script>

    <style>
        .portslide_container {
            width: 100%;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .portslide_wrapper {
            width: 1280px;
            height: 100%;
            margin: 0 auto;
        }

        .portslide_box {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .portslide_title_box {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border: 1px solid #e5e5ec;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
        }

        .portslide_title {
            font-family: 'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            font-size: 32px;
            font-weight: 400;
            color: #111;
            margin: 0;
        }

        .portslide_desc_box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .portslide_desc {
            font-family: 'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            font-size: 20px;
            color: #505050;
            margin: 0;
            text-align: center;
            line-height: 1.6;
        }

        /* ===== 슬라이드 영역 ===== */
        .portslide_proofbox {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            min-height: 650px;
        }

        .portslide_buttonbox {
            width: 640px;
            margin: 0 auto;
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3;
            pointer-events: none;
        }

        .portslide_arrow_box1,
        .portslide_arrow_box2 {
            width: 72px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            cursor: pointer;
            user-select: none;
            transition: background-color .25s ease;
        }

        .box1arrow,
        .box2arrow {
            font-size: 32px;
            line-height: 1;
            color: #111;
        }

        .box1arrow {
            transform: rotateZ(-90deg);
        }

        .box2arrow {
            transform: rotateZ(90deg);
        }

        .portslide_img_box {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%) translateX(0);
            display: flex;
            align-items: center;
            gap: 40px;
            transition: transform .6s ease;
            will-change: transform;
            z-index: 1;
        }

        .portslide_img {
            flex: 0 0 460px;
            width: 460px;
            height: 650px;
            overflow: hidden;
            transform: scale(.7);
            opacity: .7;
            transition: transform .4s ease, opacity .4s ease, box-shadow .3s ease;
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }

        .portslide_img.is-active {
            transform: scale(1);
            opacity: 1;
            z-index: 2;
            box-shadow: 0 16px 40px rgba(17, 17, 17, .2);
        }

        .portslide_img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
    </style>
</head>

<body>

    <section class="portslide_container">
        <div class="portslide_wrapper">
            <div class="portslide_box">
                <div class="portslide_title_box">
                    <p class="portslide_title">1. 강아지 슬개골 탈구 수술 - 작은 무릎, 큰 문제 : 강아지 슬개골 탈구 이야기</p>
                    <i class="fa-regular fa-angle-down" aria-hidden="true"></i>
                </div>

                <div class="portslide_desc_box">
                    <p class="portslide_desc">
                        "강아지 슬개골 탈구는 소형견에서 흔히 나타나는 정형외과 질환으로,<br>
                        다리 구조와 성장과정의 이상이 주요 원인입니다"
                    </p>
                    <p class="portslide_desc">
                        이 내용을 공부하며 수술 원리와 회복 과정을<br>
                        보호자의 눈높이에 맞춰 풀어낼 수 있는 글을 준비할 수 있었습니다.
                    </p>
                </div>

                <div class="portslide_proofbox">
                    <!-- 버튼 -->
                    <div class="portslide_buttonbox" aria-hidden="false">
                        <div class="portslide_arrow_box1" role="button" aria-label="이전 슬라이드">
                            <i class="fa-regular fa-angle-up box1arrow"></i>
                        </div>
                        <div class="portslide_arrow_box2" role="button" aria-label="다음 슬라이드">
                            <i class="fa-regular fa-angle-up box2arrow"></i>
                        </div>
                    </div>

                    <!-- 트랙 -->
                    <div class="portslide_img_box">
                        <div class="portslide_img"><img src="https://ncryk7.mycafe24.com/tiger1.jpg" alt=""></div>
                        <div class="portslide_img"><img src="https://ncryk7.mycafe24.com/tiger2.jpg" alt=""></div>
                        <div class="portslide_img"><img src="https://ncryk7.mycafe24.com/tiger3.jpg" alt=""></div>
                        <div class="portslide_img"><img src="https://ncryk7.mycafe24.com/eagle1.jpg" alt=""></div>
                        <div class="portslide_img"><img src="https://ncryk7.mycafe24.com/eagle2.jpg" alt=""></div>
                        <div class="portslide_img"><img src="https://ncryk7.mycafe24.com/eagle3.jpg" alt=""></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        (function () {
            const proofbox = document.querySelector('.portslide_proofbox');
            const track = document.querySelector('.portslide_img_box');
            const prevBtn = document.querySelector('.portslide_arrow_box1');
            const nextBtn = document.querySelector('.portslide_arrow_box2');

            const titleBox = document.querySelector('.portslide_title_box');
            const descBox = document.querySelector('.portslide_desc_box');

            /* 아코디언 처음 펼치려면 true, 닫아서 시작하려면 false */
            const INITIAL_OPEN = true;

            titleBox.setAttribute('role', 'button');
            titleBox.setAttribute('tabindex', '0');
            titleBox.setAttribute('aria-controls', 'portslide-accordion-desc portslide-accordion-proof');
            titleBox.setAttribute('aria-expanded', INITIAL_OPEN ? 'true' : 'false');

            descBox.id = 'portslide-accordion-desc';
            proofbox.id = 'portslide-accordion-proof';

            track.style.willChange = 'transform';

            /** 공통 전환 스타일 */
            const accordionTargets = [descBox, proofbox];
            accordionTargets.forEach(el => {
                el.style.overflow = 'hidden';
                el.style.transition = 'max-height .36s ease, opacity .28s ease';
                if (INITIAL_OPEN) {
                    el.style.maxHeight = 'none';
                    el.style.opacity = '1';
                } else {
                    el.style.maxHeight = '0px';
                    el.style.opacity = '0';
                }
            });

            /** NOTE: CSS의 .portslide_proofbox { min-height:650px; }가 접힘을 방해하므로
             * 닫을 때는 inline으로 minHeight=0, 열리면 콘텐츠 높이로 재설정한다. */
            if (!INITIAL_OPEN) {
                proofbox.style.minHeight = '0px';
            }

            let isOpen = INITIAL_OPEN;

            function animateOpen(el) {
                // 열기: 현재 높이를 시작점으로 잡고, scrollHeight까지 전환
                // proofbox는 먼저 실제 콘텐츠 높이에 맞춰 minHeight를 설정
                if (el === proofbox) {
                    const contentH = readActiveSlideHeight();
                    // 안전장치: 최소 1px 이상
                    proofbox.style.minHeight = Math.max(1, contentH) + 'px';
                }
                const startH = el.getBoundingClientRect().height;
                el.style.maxHeight = startH + 'px';
                requestAnimationFrame(() => {
                    const targetH = el.scrollHeight;
                    el.style.opacity = '1';
                    el.style.maxHeight = targetH + 'px';
                    const onEnd = (e) => {
                        if (e.propertyName !== 'max-height') return;
                        el.style.maxHeight = 'none'; // 열림 상태에선 자연 높이 유지
                        el.removeEventListener('transitionend', onEnd);
                    };
                    el.addEventListener('transitionend', onEnd);
                });
            }

            function animateClose(el) {
                // 닫기: 현재 높이를 시작점으로 잡고 max-height 0으로 전환
                const currentH = el.getBoundingClientRect().height;
                el.style.maxHeight = currentH + 'px';
                requestAnimationFrame(() => {
                    el.style.opacity = '0';
                    el.style.maxHeight = '0px';
                });
                // proofbox는 닫히는 동안도 실제로 높이가 0이 되도록 minHeight도 0으로
                if (el === proofbox) {
                    proofbox.style.minHeight = '0px';
                }
            }

            function openAccordion() {
                isOpen = true;
                titleBox.setAttribute('aria-expanded', 'true');
                accordionTargets.forEach(animateOpen);
                // 열리면서 레이아웃 안정화
                setTimeout(() => {
                    syncBoxHeight();
                    centerActive(true);
                }, 60);
            }

            function closeAccordion() {
                isOpen = false;
                titleBox.setAttribute('aria-expanded', 'false');
                accordionTargets.forEach(animateClose);
            }

            function toggleAccordion() {
                if (isOpen) closeAccordion(); else openAccordion();
            }

            titleBox.addEventListener('click', toggleAccordion);
            titleBox.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleAccordion();
                }
            });

            /** 무한 슬라이드 준비 */
            const originals = Array.from(track.querySelectorAll('.portslide_img'));
            const N = originals.length;

            for (let i = N - 1; i >= 0; i--) {
                const c = originals[i].cloneNode(true);
                c.dataset.clone = '1';
                track.insertBefore(c, track.firstChild);
            }
            for (let i = 0; i < N; i++) {
                const c = originals[i].cloneNode(true);
                c.dataset.clone = '1';
                track.appendChild(c);
            }

            const slides = Array.from(track.querySelectorAll('.portslide_img'));
            const START = N;
            let index = START;
            let animLock = false;

            const getItemWidth = () => {
                const cs = getComputedStyle(slides[0]);
                return parseFloat(cs.width);
            };
            const getGap = () => {
                const g = getComputedStyle(track).gap || '0px';
                return parseFloat(g);
            };

            function applyActive() {
                slides.forEach((el, i) => el.classList.toggle('is-active', i === index));
            }

            function centerActive(noAnim = false) {
                const boxW = proofbox.clientWidth;
                if (!boxW) return;

                const itemW = getItemWidth();
                const gap = getGap();
                const step = itemW + gap;
                const centerOffset = (boxW - itemW) / 2;
                const shift = centerOffset - (index * step);

                if (noAnim) {
                    const prev = track.style.transition;
                    track.style.transition = 'none';
                    track.style.transform = `translateY(-50%) translateX(${shift}px)`;
                    void track.offsetHeight;
                    track.style.transition = prev || 'transform .6s ease';
                } else {
                    track.style.transform = `translateY(-50%) translateX(${shift}px)`;
                }
            }

            function normalizeIndexIfNeeded() {
                if (index < START) {
                    index += N;
                    applyActive();
                    centerActive(true);
                } else if (index >= START + N) {
                    index -= N;
                    applyActive();
                    centerActive(true);
                }
            }

            function goTo(newIndex) {
                if (animLock) return;
                animLock = true;
                index = newIndex;
                applyActive();
                centerActive(false);
            }

            prevBtn.addEventListener('click', () => goTo(index - 1));
            nextBtn.addEventListener('click', () => goTo(index + 1));

            track.addEventListener('transitionend', (e) => {
                if (e.propertyName !== 'transform') return;
                normalizeIndexIfNeeded();
                animLock = false;
                // 슬라이드 이동 후 높이 재동기화 (열려있을 때만)
                if (isOpen) syncBoxHeight();
            });

            function readActiveSlideHeight() {
                const active = track.querySelector('.portslide_img.is-active') || track.querySelector('.portslide_img');
                if (!active) return 0;
                // 실제 카드 높이
                return active.getBoundingClientRect().height || active.offsetHeight || 0;
            }

            function syncBoxHeight() {
                // 열려 있을 때만 콘텐츠 높이에 맞춰 proofbox minHeight를 설정
                if (!isOpen) return;
                const h = readActiveSlideHeight();
                if (h > 0) {
                    proofbox.style.minHeight = h + 'px';
                }
            }

            /** 리사이즈 */
            window.addEventListener('resize', () => {
                syncBoxHeight();
                centerActive(true);
            });

            /** 이미지 로딩 완료 후 초기화 */
            const imgs = Array.from(track.querySelectorAll('img'));
            Promise.all(
                imgs.map(img => {
                    if (img.decode) return img.decode().catch(() => { });
                    return new Promise(res => {
                        if (img.complete) return res();
                        img.addEventListener('load', () => res(), { once: true });
                        img.addEventListener('error', () => res(), { once: true });
                    });
                })
            ).then(() => {
                applyActive();
                if (INITIAL_OPEN) {
                    syncBoxHeight();   // 시작 시 슬라이드 높이로 맞춤
                    centerActive(true);
                } else {
                    // 닫혀 시작하면 확실히 0으로
                    proofbox.style.minHeight = '0px';
                }
            });
        })();
    </script>

</body>

</html>